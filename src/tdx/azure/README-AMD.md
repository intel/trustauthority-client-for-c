# Build the C adapter for Azure AMD

```
gcc azure_tdx_adapter.c main.c ../../log/log.c ../../connector/base64.c ../../connector/rest.c ../../connector/connector.c ../../connector/json.c  -I../../../include -I ../../connector -lcrypto -ltss2-esys -ljansson -lcurl
```

# check the library symbols

```
nm libtrustauthority_tdx_azure.a

00000000000002bc T azure_amd_adapter_new
00000000000003cd T amd_adapter_free
0000000000000fbe T amd_collect_evidence_azure

0000000000000205 T azure_tdx_adapter_new
000000000000036e T tdx_adapter_free
000000000000042c T tdx_collect_evidence_azure
```

# Memory report

azureuser@amdvm:~/c-adapter/amd-for-c/trustauthority-client-for-c/src/tdx/azure$ sudo valgrind --leak-check=full --track-origins=yes ./a.out
==656926== Memcheck, a memory error detector
==656926== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==656926== Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info
==656926== Command: ./a.out
==656926==
Evidence Type: 1682200832
Evidence (Hex): 02000000070000001f000300000000000100000000000000000000000000000002000000000000000000000000000000000000000100000004000000000015d501000000000000000000000000000000b0e54694a657ba9409d02e4bd01a92d9f406192498c1a3a421a8eabf216fa6090000000000000000000000000000000000000000000000000000000000000000036fc22b517981a791f7f8b89d634a00e964f6b0dfabc568090eb4393d6026f96aa6b7cca2759f29e521469f1189c00c00000000000000000000000000000000000000000000000000000000000000000356215882a825279a85b300b0b742931d113bf7e32dde2e50ffde7ec743ca491ecdd7f336dc28a6e0b2bb57af7a44a30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004a4acb6e6f2f31499cf46087768688c45b91a3fbf52d50112c121e15f7eced97ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04000000000015d3000000000000000000000000000000000000000000000000eab0356b21d684141e3e12ba369b399bec00487f33454488a1d1543d29749f69b1da35a4d0cf7538808a987168914bc9fc153ac5ebfb2adb5325381f0d789fc304000000000015d3113701001137010004000000000015d30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009b6e625cf5c5bdec5274a59792a90847bc4c280afe8620087607a0c0a76aee5a1ed2ebb27125a91c8af7bf64ef0ebae900000000000000000000000000000000000000000000000073264e210b6b15074a646bd5e44723a97b5ad7f23517bb9c0df611fbbb7fd294724ecc7f6de35b755d0193c05b1d8d0d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
User Data (Hex): 616263
Runtime Data (Hex): 7b226b657973223a5b7b226b6964223a2248434c416b507562222c226b65795f6f7073223a5b227369676e225d2c226b7479223a22525341222c2265223a2241514142222c226e223a226a6a766934414142494b4837704e456c77655077424a5752394c68644668634d4e706d4b7037355573366a65756f344e726a505438437a737a5f72506f5634693341614449614979444657647646444a45306d6654544352442d51445245616f413168652d487579514977744c2d5a48706f5a514866683243396745316c334b4d31745a337045413069762d7366445171484f385976527336716f3834446838746254796d71597a36632d57516d4e62395662594a62706e4d6a4e6d4d734f425469306335372d53614b6749694e556336666233712d47356b4d4d67454253305644354f5a75546d73386f466b6b54486c57646a796a593247762d4932773171535a6e5a7061506a58684b4a434773675f71386f5f694a71446b65384f4f567068536b5662656e554f6f705050504b36332d437534427938627153347673526a6559764b38794a3869304b363365556b6f5574495351227d2c7b226b6964223a2248434c456b507562222c226b65795f6f7073223a5b22656e6372797074225d2c226b7479223a22525341222c2265223a2241514142222c226e223a22315178493251414154364a794c5a564662784a35684b716b496174557a4d4b4a656a49666d636e5a4b3965782d504b4c4a3677675a4e5763436e336850526c45426a385a48594264437a67344e496c714c4c49716136415f636d596934463254305145397a4656484e374b74564e5f6174714e6a6e75304d74573141693356397671755a625454522d49734b6e34725544714b33625768627a3766386b35726272595449675a4349304b4b5f565f6543694243394938665a3039376a4c5a32724e70543070323834584c5771706e796e5261704c72316a78354752525666354a6b58655353774337506174575a7136442d364e79676175436b302d35665730777272384f476649656139736939794551573858614c474f496a4959595a36574232627a3444315f7675545f4c78556c57504644346c587436324842553650332d476b72396d38416c5155306a4f366450644551513051227d5d2c22766d2d636f6e66696775726174696f6e223a7b22636f6e736f6c652d656e61626c6564223a747275652c227365637572652d626f6f74223a747275652c2274706d2d656e61626c6564223a747275652c22766d556e697175654964223a2230464643453646312d454446412d343731422d394241362d344644334642363437383736227d2c22757365722d64617461223a224444414633354131393336313741424143433431373334394145323034313331313245364641344538394139374541323041394545454536344235354433394132313932393932413237344643314138333642413343323341334645454242443435344434343233363433434538304532413941433934464135344341343946227d
Runtime data: {"keys":[{"kid":"HCLAkPub","key_ops":["sign"],"kty":"RSA","e":"AQAB","n":"jjvi4AABIKH7pNElwePwBJWR9LhdFhcMNpmKp75Us6jeuo4NrjPT8Czsz_rPoV4i3AaDIaIyDFWdvFDJE0mfTTCRD-QDREaoA1he-HuyQIwtL-ZHpoZQHfh2C9gE1l3KM1tZ3pEA0iv-sfDQqHO8YvRs6qo84Dh8tbTymqYz6c-WQmNb9VbYJbpnMjNmMsOBTi0c57-SaKgIiNUc6fb3q-G5kMMgEBS0VD5OZuTms8oFkkTHlWdjyjY2Gv-I2w1qSZnZpaPjXhKJCGsg_q8o_iJqDke8OOVphSkVbenUOopPPPK63-Cu4By8bqS4vsRjeYvK8yJ8i0K63eUkoUtISQ"},{"kid":"HCLEkPub","key_ops":["encrypt"],"kty":"RSA","e":"AQAB","n":"1QxI2QAAT6JyLZVFbxJ5hKqkIatUzMKJejIfmcnZK9ex-PKLJ6wgZNWcCn3hPRlEBj8ZHYBdCzg4NIlqLLIqa6A_cmYi4F2T0QE9zFVHN7KtVN_atqNjnu0MtW1Ai3V9vquZbTTR-IsKn4rUDqK3bWhbz7f8k5rbrYTIgZCI0KK_V_eCiBC9I8fZ097jLZ2rNpT0p284XLWqpnynRapLr1jx5GRRVf5JkXeSSwC7PatWZq6D-6NygauCk0-5fW0wrr8OGfIea9si9yEQW8XaLGOIjIYYZ6WB2bz4D1_vuT_LxUlWPFD4lXt62HBU6P3-Gkr9m8AlQU0jO6dPdEQQ0Q"}],"vm-configuration":{"console-enabled":true,"secure-boot":true,"tpm-enabled":true,"vmUniqueId":"0FFCE6F1-EDFA-471B-9BA6-4FD3FB647876"},"user-data":"DDAF35A193617ABACC417349AE20413112E6FA4E89A97EA20A9EEEE64B55D39A2192992A274FC1A836BA3C23A3FEEBBD454D4423643CE80E2A9AC94FA54CA49F"}
Event Log: NULL or Empty
Evidence Length: 1184
User Data Length: 3
Runtime Data Length: 1110
Event Log Length: 0
AMD evidence collected successfully.
==656926==
==656926== HEAP SUMMARY:
==656926== in use at exit: 0 bytes in 0 blocks
==656926== total heap usage: 1,585 allocs, 1,585 frees, 151,470 bytes allocated
==656926==
==656926== All heap blocks were freed -- no leaks are possible
==656926==
==656926== For lists of detected and suppressed errors, rerun with: -s
==656926== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
